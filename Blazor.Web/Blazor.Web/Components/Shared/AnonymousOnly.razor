@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Nav

@if (!_checked || _redirecting)
{
    <div></div>
}
else
{
    @ChildContent
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string RedirectUrl { get; set; } = "/";

    private bool _checked;
    private bool _redirecting;
    private bool _subscribed;

    protected override void OnInitialized()
    {
        if (!_subscribed)
        {
            AuthProvider.AuthenticationStateChanged += OnAuthStateChanged;
            _subscribed = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _checked || _redirecting) return;

        var state = await AuthProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            _redirecting = true;
            Nav.NavigateTo(RedirectUrl, forceLoad: false);
            return;
        }

        _checked = true;
        StateHasChanged();
    }

    private void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        if (_redirecting) return;
        var state = task.GetAwaiter().GetResult();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            _redirecting = true;
            Nav.NavigateTo(RedirectUrl, forceLoad: false);
        }
        else if (!_checked)
        {
            _checked = true;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        if (_subscribed)
        {
            AuthProvider.AuthenticationStateChanged -= OnAuthStateChanged;
        }
    }
}
