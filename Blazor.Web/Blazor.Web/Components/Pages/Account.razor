@page "/Account"
@rendermode InteractiveServer

@using Blazor.Web.Logic.Services.Validation
@using Blazor.Web.Logic.User
@using Blazor.Web.Logic.Auth
@using Blazor.Web.Domain.Auth
@using Microsoft.AspNetCore.Components.Authorization

<AnonymousOnly RedirectUrl="/">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mx-auto">
                <div class="text-center mt-5" style="font-size:20px;">
                    App Account - @(_isRegisterMode ? "Register" : "Login")
                </div>

                @if (!_isRegisterMode)
                {
                    <!-- LOGIN FORM -->
                    <EditForm Model="_loginUser" OnValidSubmit="HandleLoginSubmit" FormName="LoginForm">
                        <div class="mb-3">
                            <label for="login-username" class="form-label">Username</label>
                            <InputText id="login-username"
                                       @bind-Value="_loginUser.Username"
                                       class="form-control form-control-lg"
                                       autocomplete="off" />
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <InputText id="login-password"
                                       @bind-Value="_loginUser.UserPassword"
                                       type="password"
                                       class="form-control form-control-lg"
                                       autocomplete="off" />
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-info btn-lg">Log in</button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" @onclick="SwitchToRegister">
                                Need an account? Register
                            </button>
                        </div>
                        @if (_validationErrors.Count > 0)
                        {
                            <ul class="mt-3 text-danger">
                                @foreach (var e in _validationErrors)
                                {
                                    <li>@e</li>
                                }
                            </ul>
                        }
                    </EditForm>
                }
                else
                {
                <!-- REGISTRATION FORM -->
                    <EditForm Model="_registerUser" OnValidSubmit="HandleRegisterSubmit" FormName="RegisterForm">
                        <div class="mb-3">
                            <label for="reg-username" class="form-label">Username</label>
                            <InputText id="reg-username"
                                       @bind-Value="_registerUser.Username"
                                       class="form-control form-control-lg"
                                       autocomplete="off" />
                        </div>
                        <div class="mb-3">
                            <label for="reg-password" class="form-label">Password</label>
                            <InputText id="reg-password"
                                       @bind-Value="_registerUser.UserPassword"
                                       type="password"
                                       class="form-control form-control-lg"
                                       autocomplete="off" />
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-success btn-lg">Register </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" @onclick="SwitchToLogin">
                                Back to login
                            </button>
                        </div>
                        @if (_validationErrors.Count > 0)
                        {
                            <ul class="mt-3 text-danger">
                                @foreach (var e in _validationErrors)
                                {
                                    <li>@e</li>
                                }
                            </ul>
                        }
                    </EditForm>
                }
            </div>
        </div>
    </div>

    @if (_showUserConfirmationModal)
    {
        <UserConfirmationModal Title="@_confirmationModalTitle"
                               BodyText="@_confirmationModalBody"
                               ConfirmText="@_confirmationModalConfirmText"
                               OnConfirm="@_onConfirmAction"
                               OnClose="HideRegisterConfirmationModal" />
    }
</AnonymousOnly>

    @code {
    private global::App.Models.Dtos.LoginUserDto _loginUser = new();
    private global::App.Models.Dtos.RegisterUserDto _registerUser = new();
    private List<string> _validationErrors = new();

    private bool _showUserConfirmationModal;
    private string _confirmationModalTitle = "Account";
    private string _confirmationModalBody = "";
    private string _confirmationModalConfirmText = "";
    private Func<Task> _onConfirmAction = () => Task.CompletedTask;
    private bool _isRegisterMode;

    [Inject] private IUserLogic UserLogic { get; set; } = null!;
    [Inject] private ICredentialValidator Validator { get; set; } = null!;
    [Inject] private NavigationManager Nav { get; set; } = null!;
    [Inject] private AuthenticationStateProvider AuthProvider { get; set; } = null!;
    [Inject] private ITokenStore TokenStore { get; set; } = null!;
    [Inject] private IAuthenticationService AuthService { get; set; } = null!;

    private async Task HandleLoginSubmit()
    {
        var result = await AuthService.LoginAsync(_loginUser);

        if (result.Success)
        {
            await CompleteAuthenticationAsync();
        }
        else if (result.ErrorCode == global::App.Models.Models.AppErrorCode.UserNotFound.ToString())
        {
            _confirmationModalTitle = "Account Not Found";
            _confirmationModalBody = $"We could not find user '{_loginUser.Username}'. Switch to register?";
            _confirmationModalConfirmText = "Switch to Register";
            _onConfirmAction = SwitchToRegister;
            _showUserConfirmationModal = true;
        }
        else if (result.ErrorCode == global::App.Models.Models.AppErrorCode.NotFound.ToString())
        {
            // HTTP 404 - API endpoint not found (infrastructure issue)
            _validationErrors.Add("Unable to connect to authentication service. Please contact support.");
        }
        else
        {
            _validationErrors = result.Errors;
        }
    }

    private async Task HandleRegisterSubmit()
    {
        var result = await AuthService.RegisterAsync(_registerUser);

        if (result.Success)
        {
            await CompleteAuthenticationAsync();
        }
        else if(result.ErrorCode == global::App.Models.Models.AppErrorCode.UserAlreadyExists.ToString())
        {
            _confirmationModalTitle = "Account Exists";
            _confirmationModalBody = $"An account with username '{_registerUser.Username}' already exists. Please choose a different username. Or switch to login?";
            _confirmationModalConfirmText = "Switch to Login";
            _onConfirmAction = SwitchToLogin;
            _showUserConfirmationModal = true;
        }
        else if (result.ErrorCode == global::App.Models.Models.AppErrorCode.NotFound.ToString())
        {
            // HTTP 404 - API endpoint not found (infrastructure issue)
            _validationErrors.Add("Unable to connect to authentication service. Please contact support.");
        }
        else
        {
            _validationErrors = result.Errors;
        }
    }

    private async Task CompleteAuthenticationAsync()
    {
        var token = TokenStore.AccessToken;
        if (!string.IsNullOrWhiteSpace(token) && AuthProvider is CustomAuthenticationStateProvider custom)
        {
            await custom.MarkUserAsAuthenticatedAsync(token);
        }
        Nav.NavigateTo("/");
    }

    private Task SwitchToRegister()
    {
        _showUserConfirmationModal = false;
        _isRegisterMode = true;
        _registerUser.Username = _loginUser.Username;
        _registerUser.UserPassword = _loginUser.UserPassword;
        _validationErrors.Clear();
        return Task.CompletedTask;
    }

    private Task SwitchToLogin()
    {
        _showUserConfirmationModal = false;
        _isRegisterMode = false;
        _registerUser.Username = _loginUser.Username;
        _registerUser.UserPassword = _loginUser.UserPassword;
        _validationErrors.Clear();
        return Task.CompletedTask;
    }

    private Task HideRegisterConfirmationModal()
    {
        _showUserConfirmationModal = false;
        return Task.CompletedTask;
    }

}